**介绍：** 一个调用 LLM API 进行时空序列预测(交通流量预测)的框架。核心功能亮点如下：

1. 封装了常用操作，如生成数据子集、带缓存的 API 调用、日志和可视化等。
2. 支持快速扩展，可以方便添加多种不同的 API、提示词、数据集。
3. 实现了几种不同的常用提示词和 HA 基准模型。

> 版权所有，如您需要使用本项目(如使用本文档提供的实验结果数据)，请标记出处/引用。

## 项目结构

包依赖参见 `requirements.txt`。

数据集 `data/`

- > `raw/` 原始数据 (自行下载，如参考 [STD-MAE](https://github.com/Jimmy-7664/STD-MAE) 的 `raw_data/`，目前无使用)
  >
- `processed/` 参考 [BasicTS](https://github.com/GestaltCogTeam/BasicTS) datasets，形成如 `processed/PEMS03` 的目录结构。

数据处理等 `utils/`

- `datasets/` 数据集操作

  - `graphHandler.py` 图读取和基本操作
  - `timeHandler.py` 计算数据集的时间
  - `statHandler.py` 基于数据集计算数据集统计量(如历史平均)
  - `calcHandler.py` 基于数据计算数据集统计量(如均值、自相关)
  - `dataset.py` 数据集读取和划分
  - `handler.py` 上面内容的捆绑包
  - `data.py` 输入、输出、真实值、评估结果集成及其存取
- `metrics/` 评价指标实现参考 [BasicTS](https://github.com/GestaltCogTeam/BasicTS)

  - `evaluation.py` 进行准确率评估
  - `plot.py` 绘图可视化对比结果
- `common/` 基础通用代码

  - `log.py` 输出和日志
- `baselines/` 基准模型

  - `HA.py`，历史平均值，不同节点、不同时间片、星期的三维度的平均值用作预测
  - `baselineResults.py` 对基准模型结果进行展示对比等
  - `baselineResults.csv` 部分经典基准模型结果

提示词工程实验：`prompt/`

- `query.py` 带缓存的封装 API 查询
- `prompt.py` 不同的提示词方案
- `model.py` 主体类，执行实验

单元测试、调试代码等：`unittest/`

## 提示词工程

设计了4种不同的提示词，示例如下。具体参见 `prompt/prompt.py`

### plain

平凡提示词，普通输入和普通输出描述。

```
你需要完成交通流量预测任务。交通流量指的是一段时间内经过某个路口探测器的车辆的数目。探测器位于美国加州(California, USA)的中北部区域(North Central Area)。你有已知数据，为12个连续时间区间(每个时间区间的长度为5分钟)的流量。
探测器从2018-11-19 15:55:00到2018-11-19 16:55:00(Monday)的流量为:302, 326, 311, 314, 304, 342, 312, 335, 323, 308, 304, 312
现在，请你预测接下来12个区间，即从2018-11-19 16:55:00到2018-11-19 17:55:00的流量。请你按照Python列表格式输出流量，保留4位小数。你只需要输出答案本身，无需输出任何计算过程和解释理由。
```

### neighbor

增加输入相邻节点(根据数据集，一般只有几个)的流量。

```
你需要完成交通流量预测任务。交通流量指的是一段时间内经过某个路口探测器的车辆的数目。探测器位于美国加州(California, USA)的中北部区域(North Central Area)。你有已知数据，为12个连续时间区间(每个时间区间的长度为5分钟)的流量。
当前探测器编号为290，探测器从2018-11-19 15:55:00到2018-11-19 16:55:00(Monday)的流量为:302, 326, 311, 314, 304, 342, 312, 335, 323, 308, 304, 312
与探测器290相邻的探测器编号为154, 289。这些探测器从2018-11-19 15:55:00到2018-11-19 16:55:00(Monday)的流量为:
探测器154的流量为514, 521, 522, 565, 523, 561, 446, 279, 297, 283, 347, 322。
探测器289的流量为388, 409, 412, 402, 369, 427, 383, 416, 395, 380, 378, 377。
现在，请你预测接下来12个区间，即从2018-11-19 16:55:00到2018-11-19 17:55:00的流量。你只需要预测探测器290的流量。请你按照Python列表格式输出流量，保留4位小数。
你只需要输出答案本身，无需输出任何计算过程和解释理由。
```

### HA

增加输入过往和未来在训练集上统计的历史平均值，该平均值由三个维度(空间点、时间(time of day)、星期)分组统计。

> 即，设 `n` 个空间点，一天有 288 个时间区间，一周 7 天，统计 `288*7n` 个平均值。

```
你需要完成交通流量预测任务。交通流量指的是一段时间内经过某个路口探测器的车辆的数目。探测器位于美国加州(California, USA)的中北部区域(North Central Area)。你有已知数据，为12个连续时间区间(每个时间区间的长度为5分钟)的流量。
探测器从2018-11-19 15:55:00到2018-11-19 16:55:00(Monday)的流量为:302, 326, 311, 314, 304, 342, 312, 335, 323, 308, 304, 312
现在，请你预测接下来12个区间，即从2018-11-19 16:55:00到2018-11-19 17:55:00的流量。请你按照Python列表格式输出流量，保留4位小数。你只需要输出答案本身，无需输出任何计算过程和解释理由。
```

### HA_neighbor

结合 HA 和 neighbor 提示词，对邻节点也输出历史流量。

```
你需要完成交通流量预测任务。交通流量指的是一段时间内经过某个路口探测器的车辆的数目。探测器位于美国加州(California, USA)的中北部区域(North Central Area)。你有已知数据，为12个连续时间区间(每个时间区间的长度为5分钟)的流量。
当前探测器编号为290，探测器从2018-11-19 15:55:00到2018-11-19 16:55:00(Monday)的流量为:302, 326, 311, 314, 304, 342, 312, 335, 323, 308, 304, 312
这段时间以往的平均流量是346.3750, 350.2500, 359.7500, 354.2500, 338.7500, 350.6250, 344.3750, 325.2500, 334.1250, 343.8750, 333.8750, 340.5000，因此，输入流
量距离平均值的偏差是-44.3750, -24.2500, -48.7500, -40.2500, -34.7500, -8.6250, -32.3750, 9.7500, -11.1250, -35.8750, -29.8750, -28.5000。
与探测器290相邻的探测器编号为154, 289。这些探测器从2018-11-19 15:55:00到2018-11-19 16:55:00(Monday)的流量为:
探测器154的流量为514, 521, 522, 565, 523, 561, 446, 279, 297, 283, 347, 322。这段时间以往的平均流量是512.8750, 514.8750, 509, 530.2500, 520.6250, 495.1250, 
492.3750, 491.2500, 481.1250, 499.3750, 488.3750, 483.3750，因此，输入流量距离平均值的偏差是-210.8750, -188.8750, -198, -216.2500, -216.6250, -153.1250, -180.3750, -156.2500, -158.1250, -191.3750, -184.3750, -171.3750。
探测器289的流量为388, 409, 412, 402, 369, 427, 383, 416, 395, 380, 378, 377。这段时间以往的平均流量是420.3750, 416.7500, 425.3750, 414.6250, 419.3750, 420.7500, 418, 396.2500, 412.2500, 420, 413.8750, 419.1250，因此，输入流量距离平均值的偏差是-118.3750, -90.7500, -114.3750, -100.6250, -115.3750, -78.7500, -106, -61.2500, -89.2500, -112, -109.8750, -107.1250。
现在，请你预测接下来12个区间，即从2018-11-19 16:55:00到2018-11-19 17:55:00的流量。你只需要预测探测器290的流量。你要预测的12个区间的在过往的平均流量是335.3750, 344.2500, 353, 346.5000, 341.1250, 333.3750, 345.2500, 318.6250, 335.2500, 331.3750, 338.7500, 343.7500。
请你按照Python列表格式输出流量，保留4位小数。你只需要输出答案本身，无需输出任何计算过程和解释理由。
```

> 可以还有一个版本，对邻节点不输入 HA，只输入常规流量。

> 其他思路：
>
> - [xTP-LLM](https://github.com/Guoxs/xTP-LLM) 使用天气、区域特征、节假日等，需要数据支持。
> - [UrbanGPT](https://github.com/HKUDS/UrbanGPT) I/O flow，可能的空间描述。(没给例子)
> - [AuMobLCast](https://github.com/cruiseresearchgroup/AuxMobLCast) POI 信息描述

## 实验结果

考虑随机取测试集的一部分，用部分值代替整体。确定何时部分值收敛。经过测试，当取 32/64 个测试点(设一个测试点=随机 12 个区间1小时输入，单个探测器空间点)时，结果基本稳定，PEMS03 的 MAPE 误差在 1% 以内。所以这里按 32 个测试点，计算实验结果，如下：

> 其中，(T) 是使用深度思考。可见，与不使用相比，提升效果不明显。

```
PEMS03-64:
              mae      mape       rmse
Plain   23.368322  0.206827  34.952785
HA      19.761604  0.169685  30.892782
HA_Nei  16.206450  0.147683  24.311964

PEMS03-32:
                mae      mape       rmse
Plain     32.979980  0.249627  46.975353
Neighbor  26.727194  0.204145  36.791534
HA        22.045837  0.150311  33.868702
HA_Nei    19.058632  0.140031  26.726738
HA_Nei(T) 18.892052  0.123374  28.649897

PEMS04-32:
                mae      mape       rmse
Plain     32.174080  0.184957  61.973930
Neighbor  26.929720  0.167282  54.225113
HA        29.372223  0.149416  57.545109
HA_Nei    15.777431  0.123573  32.505707

PEMS07-32:
                mae      mape       rmse
Plain     38.792011  0.129565  57.948433
Neighbor  40.558704  0.144437  63.940178
HA        39.854847  0.135642  66.284691
HA_Nei    20.265905  0.075539  28.247744

PEMS08-32:
                mae      mape       rmse
Plain     22.445910  0.132522  34.405945
Neighbor  22.497286  0.132565  34.148689
HA        21.692184  0.134507  33.723923
HA_Nei    18.505394  0.109718  30.051735

PEMS03-16-3:
                mae      mape       rmse
Plain     25.073412  0.238844  42.445835
Neighbor  24.834314  0.224607  45.987045
HA        23.087145  0.234999  35.094261
HA_Nei    17.983538  0.189089  26.264658
```

PEMS-BAY, METR-LA 数据量数量级类似，不再尝试。BasicTS 里也没有显著特别小很多的其他合适数据集了。

## 可行性分析

### API 调用

2025/8 版本，使用 Deepseek-chat，平均每次 API 调用耗费 7 秒 (包含网络和排队时延，下同)。

在 145 次询问中，使用了 10304 + 49826 tokens 输入，10440 tokens 输出。根据定价，算得 0.09-0.18 元(是否低峰期不同)。平均估计单价按 0.001 算。

则 PEMS03 的测试集为 5241x358；PEMS04 的 3398x307；PEMS07 的 5644x883；PEMS08 的 3571x170。即1e6数量级。按 7 秒一个算，分别需要 152 天，84 天，403 天，49 天。

使用深度思考 Deepseek-reasoner，调用一次 API 耗费 7-15 分钟。如果算 7 分钟，就是 60 倍，也就是 152天->24年。

所以，本机部署肯定是不可行的，哪怕不用深度思考，单线程预测，怎么跑都跑不完。只能调用现成的 API。

完整预测 PEMS，按 0.001 一次算，经费分别是 1876元，1043元，4983元，607元，约1万元，误差在一倍左右。

综上，无论是时间还是经费，都难以完整测试数据集。更不可能使用思维链。

### 本地部署

本地部署 Ollama，其他模型，在GTX3909下的推理速度：

- llama3.2:latest, 1-2s (输出格式可能不对, Plain MAPE 27.5%, HA 19.86%，其他结果很差，特别是纯 Neighbor)
- deepseek-coder-v2:16b 2-7s(根据提示词不同, 会报错，没跑完，输出格式可能不对)
- deepseek-v2:16b 2-5s(根据提示词不同, 会报错，没跑完，输出格式可能不对)
- qwen-v2.5:14b(2-3s,结果还不错)
- qwen-v2.5:7b(1.5-2s)
- qwen-v2.5:3b(1-1.5s)
- qwen-v2.5:1.5b (0.5-1s，但是感觉完全不能用)

qwen v2.5 14b

```
                mae      mape       rmse
Plain     30.260345  0.233959  42.954220
Neighbor  36.679924  0.262437  50.501282
HA        23.281046  0.176874  32.165596
HA_Nei    21.713377  0.158260  29.558413
```

qwen v2.5 7b

```
Plain     33.018703  0.230598  47.984669
Neighbor  32.003510  0.251705  42.949974
HA        25.473345  0.192144  35.987968
HA_Nei    25.349874  0.190306  34.613869
```

qwen v2.5 3b

```
                mae      mape       rmse
Plain     25.577576  0.186899  38.242775
Neighbor  44.792431  0.281817  72.165588
HA        23.300787  0.184814  32.613194
HA_Nei    26.878693  0.196762  35.406658
```

qwen v2.5 1.5b

```
                 mae      mape        rmse
Plain      97.148232  0.630173  138.297760
Neighbor  116.633118  0.665671  168.349121
HA         59.398026  0.426328   93.485176
HA_Nei     67.674538  0.427223  114.144173
```
