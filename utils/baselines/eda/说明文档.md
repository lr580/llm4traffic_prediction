# utils/baselines/eda 说明文档

## 目录概览

当前目录位于 `utils/baselines/eda`，所有脚本默认从仓库根目录运行（示例命令：`python utils/baselines/eda/<script>.py`），并假设 LargeST 原始数据位于 `data/LargeST/`，PeMS 相关数据位于 `data/ASTGCN/`, `data/STSGCN/`, `data/processed/` 或 `datasets/` 等上级目录。

## LargeST 相关脚本

- **`LargeST_build_topology_map.py`**
  - 功能：读取 `ca_meta.csv` 与 `ca_rn_adj.npy`，构建 8600 个探测器的 Leaflet 交互拓扑，附带聚类、邻接表、权重渐变等组件，可限制邻边展示数量与地图点击范围。
  - 运行：`python utils/baselines/eda/LargeST_build_topology_map.py`，如需定制交互可修改文件顶部的 `NEIGHBOR_DISPLAY_LIMIT`、`MAP_CLICK_RANGE_KM` 等常量。
  - 输出：`LargeST_topology.html`（浏览器端交互式地图，需要加载地图则请挂梯子）。
- `LargeST_EDA_flow.py`
  - 功能：探查 `data/LargeST/ca_his_raw_2019.h5` 的 HDF5 结构，列出 group/dataset、示例切片，并提供 `inspect_h5_dataset` 以复用。
  - 运行：`python utils/baselines/eda/LargeST_EDA_flow.py`，若更换数据源只需修改 `path` 变量。
  - 输出：终端打印 H5 结构、前若干元素、数组切片等。
- `LargeST_EDA_geo.py`
  - 功能：计算探测器之间的哈弗辛距离(测地距离)，可在“全对”或“仅限存在邻边”模式下统计分布、输出直方图。
  - 运行：示例 `python utils/baselines/eda/LargeST_EDA_geo.py --edges-only --bins 30 --dtype float32 --savefig data/LargeST/geo_hist_edges.png`，`--small-thresholds` 控制自定义距离阈值统计。
  - 输出：命令行统计摘要 + 可选 PNG 直方图。
- `LargeST_EDA_graph.py`
  - 功能：对 `ca_rn_adj.npy` 做全方位输出，打印数据类型、稀疏度、对称性，绘制全体/非零权重直方图；附带更深入的差分与显著性检验脚本（默认注释）。
  - 运行：`python utils/baselines/eda/LargeST_EDA_graph.py`，若需启用附加模块，将 `if False` 改为 `if True`。
  - 输出：终端统计 + Matplotlib 可交互窗口。
- `LargeST_neighbor_distance.py`
  - 功能：对每个节点计算所有邻居的地理距离并排序，输出完整 JSON、最小距离 CSV、Top-K 命令行摘要以及可视化柱状图。
  - 运行：`python utils/baselines/eda/LargeST_neighbor_distance.py --output-json data/LargeST/neighbor_distance_stats.json --output-csv data/LargeST/neighbor_min_summary.csv --top-k 25 --savefig data/LargeST/neighbor_min_dist.svg`，通过 `--edge-threshold` 过滤弱边。
  - 输出：JSON + CSV + 可选 SVG/PNG。
- `LargeST_neighbor_distance_hist.py`
  - 功能：基于 `neighbor_distance_stats.json` 汇总每个节点的最短距离，绘制直方图区分距离段，支持对数坐标。
  - 运行：`python utils/baselines/eda/LargeST_neighbor_distance_hist.py --stats data/LargeST/neighbor_distance_stats.json --bins 80 --logx --savefig data/LargeST/neighbor_min_hist.svg`。
  - 输出：最短距离统计摘要 + PNG/SVG 直方图。
- `LargeST_neighbor_edge_stats.py`
  - 功能：在双向合并的邻边上计算节点度、距离/权重分位数、均值、标准差等，并生成总体 JSON 汇总与多个直方图。
  - 运行：`python utils/baselines/eda/LargeST_neighbor_edge_stats.py --edge-threshold 0 --output-csv utils/baselines/eda/LargeST_neighbor_edge_stats.csv --output-summary utils/baselines/eda/LargeST_neighbor_edge_summary.json --figure-dir utils/baselines/eda`。
  - 输出：节点级 CSV、整体验证 JSON、`LargeST_degree_hist.png` 等图片。
- `LargeST_visualize_graph.py`
  - 功能：在经纬度平面绘制 LargeST 图，可限制边数、聚焦指定/随机节点、标注边的测地距离，并支持保存静态 PNG。
  - 运行：如 `python utils/baselines/eda/LargeST_visualize_graph.py --edge-threshold 0.3 --max-edges 20000 --node-index 1234 --output utils/baselines/eda/LargeST_node1234.png`，`--annotate-limit` 控制是否在边上叠加距离文字。
  - 输出：Matplotlib 绘图窗口或导出的 PNG。

## LargeST 结果 / 数据文件

> 需要运行脚本生成。

- **`LargeST_topology.html`**
  - 来源：`LargeST_build_topology_map.py`。
  - 用法：浏览器直接打开，即可查看节点方向、邻接表、边权渐变说明。

    [此处](https://lr580.github.io/llm4traffic_prediction/) 在线可视化查看 LargeST 数据集图结构 （浏览器端交互式地图，需要加载地图则请挂梯子）
- `LargeST_neighbor_edge_stats.csv`
  - 来源：`LargeST_neighbor_edge_stats.py` 生成的节点级统计（含 `node_index`, `degree`, 距离/权重分位数等）。
  - 用法：文件约 2.3 MB，被 `.gitignore` 忽略；可使用 `pandas.read_csv` 或 Excel 筛选异常节点。
- `LargeST_neighbor_edge_summary.json`
  - 来源：同上脚本输出的整体统计。
  - 用法：适合作为报告附件或后续脚本读取以比较不同阈值的全局差异。
- `LargeST_degree_hist.png`
  - 来源：`LargeST_neighbor_edge_stats.py` 绘制。
  - 用法：展示度分布，可直接嵌入幻灯片。
- `LargeST_distance_mean_hist.png`
  - 来源：同脚本绘制。
  - 用法：观察平均邻居距离集中区间，判断网络密度。
- `LargeST_weight_mean_hist.png`
  - 来源：同脚本绘制。
  - 用法：评估 `ca_rn_adj.npy` 权重覆盖范围。

## PEMS 系列脚本

- `pems0x_EDA.py`
  - 功能：利用 `utils.datasets.PEMSDatasetHandler` 加载 BasicTS 版本 PEMS0x，输出各站点的平均流量；注释区还整理了 LibCity 数据的下载与格式说明。
  - 运行：在 BasicTS 根目录执行 `python utils/baselines/eda/pems0x_EDA.py`，需要时将 `choice` 改为 `libcity`。
  - 输出：终端打印 PEMS03/04/07/08 四个数据集的均值向量。
- `pems0x_preview_basicts.py`
  - 功能：读取 `datasets/PEMS03/data.dat`（BasicTS 数据）并打印 5×5×3 子块，验证 memmap 顺序。
  - 运行：`python utils/baselines/eda/pems0x_preview_basicts.py`，确保 memmap 路径存在。
  - 输出：控制台展示原始值。
- `pems0x_preview_graph_basicts.py`
  - 功能：检查 `data/processed/PEMS0x/adj_mx.pkl`（BasicTS 图结构），包含维度、是否对称、度向量等。
  - 运行：`python utils/baselines/eda/pems0x_preview_graph_basicts.py`。
  - 输出：终端打印图矩阵信息，可用于验证预处理正确性。
- `pems0x_preview_processed_stdmae.py`
  - 功能：针对 STD-MAE 预处理结果（`data_in12_out12.pkl`, `index_in12_out12.pkl`, `scaler_in12_out12.pkl`）查看张量片段、滑窗索引和标准化参数。
  - 运行：`python utils/baselines/eda/pems0x_preview_processed_stdmae.py`，需要 STD-MAE 项目中的 `data/processed/PEMS0x`。
  - 输出：终端打印样本片段、索引前缀、`scaler` 内容。
- `pems0x_preview_raw.py`
  - 功能：兼容 ASTGCN/STSGCN 数据格式，绘制 `distance.csv`/`cost` 直方图并统计基础指标，同时导出 `pems0x_statistics.csv`。
  - 运行：`python utils/baselines/eda/pems0x_preview_raw.py`，需准备 `data/ASTGCN/PEMS0x` 或 `data/STSGCN/PEMS0x`。
  - 输出：Matplotlib 2×2 直方图 + CSV 汇总。

## PEMS 结果文件

- `pems0x_statistics.csv`
  - 来源：`pems0x_preview_raw.py` 自动生成。
  - 用法：包含 `dataset, mean, std, min, max, num_nodes, num_edges` 字段，可直接引用于报告或继续用来绘制比较图。
